---
title: "Dockerã§Postgreã«æ¥ç¶šã§ããªã‹ã£ãŸæ™‚ã«ç¢ºèªã—ãŸã“ã¨"
emoji: "ğŸ¥"
type: "tech"
topics:
  - "docker"
  - "go"
  - "postgres"
published: true
published_at: "2024-11-16 23:00"
---

# ã“ã®è¨˜äº‹ã«ã¤ã„ã¦
Go + PostgreSQLã®ç’°å¢ƒæ§‹ç¯‰ã‚’Dockerã§è¡Œã£ã¦ã„ãŸã¨ã“ã‚DBã®ã‚³ãƒ³ãƒ†ãƒŠã¸ã®æ¥ç¶šã§è©°ã¾ã£ã¦ã—ã¾ã£ãŸãŸã‚èª¿æŸ»ã—ã¾ã—ãŸã€‚

# ã‚¨ãƒ©ãƒ¼å†…å®¹
goã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§`go run main.go`ã‚’å®Ÿè¡Œã—ã¦ã‚‚ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚
```
2024/11/16 08:00:09 dial tcp 127.0.0.1:5432: connect: connection refused
exit status 1
```

# å‰æ
è¨­å®šã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚æœ€ä½é™ã®è¨­å®šã§ã™ã€‚

docker-compose.yml
```yaml
db:
    image: postgres:14.3
    container_name: postgres
    # posgresã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ãƒˆãŒ5432
    ports:
      - 5432:5432
    environment:
      # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
      - TZ=Asia/Tokyo
    # ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«
    env_file:
      - .env
```

.env
```
POSTGRES_PASSWORD=root
POSTGRES_USER=root
POSTGRES_DB=dev
```

# ã‚„ã£ãŸã“ã¨
## å æœ‰portã‚’ç¢ºèª
`lsof -i :5432`ã§5432ã®ãƒãƒ¼ãƒˆã®ä½¿ç”¨çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚
```
MacBook work % lsof -i :5432
COMMAND     PID USER    FD   TYPE             DEVICE SIZE/OFF NODE NAME
com.docke 20301  h_h  164u   IPv6 0x28568c6740acfe63      0t0  TCP *:postgresql (LISTEN)
postgres  48594  h_h    7u   IPv6 0xc46585475d1db213      0t0  TCP localhost:postgresql (LISTEN)
postgres  48594  h_h    8u   IPv4 0x843bf5779dd45cce      0t0  TCP localhost:postgresql (LISTEN)
```
COMMANDãŒcom.dockeã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ãŒcontainerã®ãƒãƒ¼ãƒˆã§ã€ä»–äºŒã¤ãŒä»¥å‰ãƒ­ãƒ¼ã‚«ãƒ«ã«å…¥ã‚ŒãŸpostgresã§ã—ãŸã€‚
ãªã®ã§ä¸‹äºŒã¤ã‚’killã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã¡ã‚‰ã®ã‚³ãƒãƒ³ãƒ‰ã§killã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒ†ãƒŠã®ã¿ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
```
MacBook work % kill -9 [PIDã®æ•°å­—]
```

ç¢ºèªã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜
```
MacBook work % lsof -i :5432
COMMAND     PID USER    FD   TYPE             DEVICE SIZE/OFF NODE NAME
com.docke 20301  h_h  164u   IPv6 0x28568c6740acfe63      0t0  TCP *:postgresql (LISTEN)
```

## goã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
goã®DBæ¥ç¶šã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§è¡ŒãŠã†ã¨ã—ã¦ã„ã¾ã—ãŸã€‚
```go
package main

import (
	"database/sql"
	"log"

	_ "github.com/lib/pq"
)

var Db *sql.DB
var err error
type Person struct {
	Name string
	Age  int
}

func main() {
    // ã“ã“ã®hostãŒèª¤ã‚Š
	Db, err = sql.Open("postgres", "user=root password=root dbname=dev host=localhost port=5432 sslmode=disable")
	if err != nil{
		log.Panicln(err)
	}
	defer Db.Close()

}
```

docker-composeã§èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã«ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åã®ä»£ã‚ã‚Šã«ã‚³ãƒ³ãƒ†ãƒŠåã§æ¥ç¶šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã‚‰ã—ã„ã§ã™ã€‚
ãã®ãŸã‚Openã®å¼•æ•°ã‚’`host=postgres`ã«å¤‰ãˆã¾ã—ãŸã€‚
```go
Db, err = sql.Open("postgres", "host=postgres port=5432 user=root password=root dbname=dev sslmode=disable")
```

ã“ã‚Œã§æ¥ç¶šãŒã§ãã¾ã—ãŸï¼

# å‚è€ƒè¨˜äº‹æ§˜
https://zenn.dev/json_hardcoder/articles/5925798786a07a
https://qiita.com/Keyskey/items/a1baa04d6850cc50727c