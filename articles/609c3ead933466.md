---
title: "Flutterã‚¢ãƒ—ãƒªã®CDã®å‚™å¿˜éŒ²"
emoji: "ğŸ®"
type: "tech"
topics:
  - "android"
  - "firebase"
  - "flutter"
  - "ios"
  - "githubactions"
published: true
published_at: "2024-08-30 16:02"
---

Firebaseã§ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒªã‚’é…å¸ƒã™ã‚‹ãŸã‚ã®CDã‚’GitHub Actionsã§æ§‹ç¯‰ã—ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦ã®è¨˜äº‹ã§ã™ã€‚Automatically manage signingã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚


# workflow
```yaml:iOSç”¨
name: "[DEV] Build and Publish iOS"

on:
  push:
    # developãƒ–ãƒ©ãƒ³ãƒã¸ã®pushãŒãƒˆãƒªã‚¬ãƒ¼
    branches: [develop]

jobs:
  build:
    runs-on: macos-latest
    # buildãŒæ­¢ã¾ã‚‰ãªããªã‚‹ã¨å›°ã‚‹ã®ã§30åˆ†ã‚’æŒ‡å®š
    timeout-minutes: 30
    # GitHubã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç’°å¢ƒå
    environment: 
      name: development
    steps:
      # repositoryã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract App Store Connect API Private Key in ./private_keys
        env:
          IOS_API_KEY_ID: ${{ secrets.IOS_API_KEY_ID }}
          IOS_API_AUTHKEY_P8_BASE64: ${{ secrets.IOS_API_AUTHKEY_P8_BASE64 }}
        run: |
          mkdir ./private_keys
          echo -n "$IOS_API_AUTHKEY_P8_BASE64" | base64 --decode --output ./private_keys/AuthKey_$IOS_API_KEY_ID.p8
      # flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Flutter get
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: latest
          cache: true

      - name: Check version
        run: flutter --version

      # Packageã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup packages
        run: |
          flutter pub get
          dart run build_runner build -d
      # Firebaseã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Firebase Project
        env:
          FIREBASE_PROJ_NAME: ${{ secrets.FIREBASE_PROJ_NAME }}
          FIREBASE_AUTH_TOKEN: ${{ secrets.FIREBASE_AUTH_TOKEN }}
        run: |
          curl -sL https://firebase.tools | bash
          dart pub global activate flutterfire_cli
          # i=iOS a=Android m=macOS w=Web x=Windows (--platformsã«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¦ã„ã¦ã‚‚ã€-mã‚„-xã®æŒ‡å®šã‚‚ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ä¸è¦ã§ã‚‚å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã”ã¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å…¥ã‚Œã‚‹ã€‚
          flutterfire configure -p $FIREBASE_PROJ_NAME -y --platforms "ios" -i "com.example.example-app" -a "com.example.example-app" -m "com.example.example-app"  -w "1:XXX:web:YYY" -x "1:XXX:web:YYY" -t $FIREBASE_AUTH_TOKEN -f > null
      - name: Run flutter build
        id: build
        run: flutter build ipa --release --no-codesign --dart-define-from-file=lib/flavors/json/${{ secrets.FLAVOR_ENV_NAME }}.json --build-number=$GITHUB_RUN_NUMBER

      # Automatically manage signing ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
      - name: Archive by xcodebuild
        env:
            IOS_API_ISSURE_ID: ${{ secrets.IOS_API_ISSURE_ID }}
            IOS_API_KEY_ID: ${{ secrets.IOS_API_KEY_ID }}
        run: xcodebuild archive CODE_SIGNING_ALLOWED=NO -workspace ./ios/Runner.xcworkspace -scheme Runner -configuration Release -archivePath ./build/ios/Runner.xcarchive

      # IPAã‚’build
      - name: Export by xcodebuild
        env:
          IOS_API_ISSURE_ID: ${{ secrets.IOS_API_ISSURE_ID }}
          IOS_API_KEY_ID: ${{ secrets.IOS_API_KEY_ID }}
          # ãƒ­ãƒ¼ã‚«ãƒ«ã§archiveã—ãŸã¨ãã«ä¸€ç·’ã«ç”Ÿæˆã•ã‚Œã‚‹ExportOptions.plistã®ä¸­èº«ã‚’buildã«ä½¿ç”¨ã™ã‚‹ã€‚
          # æ‰‹å‹•ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã—ãŸã¨ãã®ExportOptionsã«ã—ãªã„ã¨CDä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ãŸã‚æ³¨æ„ã€‚
          EXPORT_OPTIONS: ${{ secrets.EXPORT_OPTIONS }}
        run: |
          echo $EXPORT_OPTIONS > ios/Runner/ExportOptions.plist
          xcodebuild -exportArchive -archivePath ./build/ios/Runner.xcarchive -exportPath ./build/ios/ipa -exportOptionsPlist ./ios/Runner/ExportOptions.plist -allowProvisioningUpdates -authenticationKeyIssuerID $IOS_API_ISSURE_ID -authenticationKeyID $IOS_API_KEY_ID -authenticationKeyPath `pwd`/private_keys/AuthKey_$IOS_API_KEY_ID.p8
      # macosä¸Šã§ã¯Firebaseé…å¸ƒã®Actionã‚’å®Ÿè¡Œã§ããªã„ãŸã‚ipaãƒ•ã‚¡ã‚¤ãƒ«ã‚’artifacts storageã«ä¸€æ™‚ä¿å­˜ã™ã‚‹
      - name: Collect ipa artifacts
        uses: actions/upload-artifact@v2
        with:
          name: release-ipa
          path: build/ios/ipa/*.ipa

  release:
    name: Release ipa to Firebase
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: 
      name: development
    steps:
      - uses: actions/checkout@v4

      # artifacts storageã‹ã‚‰ipaãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Get release-ipa from artifacts
        uses: actions/download-artifact@v2
        with:
          name: release-ipa

      # Firebase Distributionã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload artifact to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
        # firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ID
          appId: ${{ secrets.FIREBASE_IOS_ID }}
          # firebaseã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®credential json
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          # firebaseãƒ†ã‚¹ã‚¿ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—
          groups: developer
          file: ${{ secrets.FLAVOR_ENV_NAME }}.ipa
          # ãƒãƒ¼ã‚¸ã—ãŸãƒ–ãƒ©ãƒ³ãƒåã‚’ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã«è¨­å®š
          releaseNotes: ${{ github.ref_name }}
          # è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
          debug: true
```



```yaml:Android
name: "[DEV] Build and Publish Android"

on:
  push:
    branches: [develop]

jobs:
  build:
    runs-on: ubuntu-latest
    # buildãŒæ­¢ã¾ã‚‰ãªããªã‚‹ã¨å›°ã‚‹ã®ã§30åˆ†ã‚’æŒ‡å®š
    timeout-minutes: 30
    # GitHubã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç’°å¢ƒ
    environment: 
      name: development
    steps:
      # repositoryã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆactionsã‚’ä½¿ã†å ´åˆã¯å¿…é ˆï¼‰
      - name: Setup repository
        uses: actions/checkout@v4

      # å®Ÿè£…æ™‚ç‚¹ã®javaã®æœ€æ–°ver
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17.x"

      # flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: latest
          cache: true

      - name: Check version
        run: flutter --version

      # Packageã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup packages
        run: |
          flutter pub get
          dart run build_runner build -d
      # Firebase Projectã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Firebase Project
        env:
          FIREBASE_PROJ_NAME: ${{ secrets.FIREBASE_PROJ_NAME }}
          FIREBASE_AUTH_TOKEN: ${{ secrets.FIREBASE_AUTH_TOKEN }}
        run: |
          curl -sL https://firebase.tools | bash
          dart pub global activate flutterfire_cli
          # i=iOS a=Android m=macOS w=Web x=Windows (--platformsã«ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¦ã„ã¦ã‚‚ã€-mã‚„-xã®æŒ‡å®šã‚‚ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚ä¸è¦ã§ã‚‚å„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã”ã¨ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å…¥ã‚Œã‚‹ã€‚
          flutterfire configure -p $FIREBASE_PROJ_NAME -y --platforms "ios, android" -i "com.example.example-app" -a "com.example.example-app" -m "com.example.example-app"  -w "1:XXX:web:YYY" -x "1:XXX:web:YYY" -t $FIREBASE_AUTH_TOKEN > null
      # key.propertiesã‚’å‡ºåŠ›
      - name: Create key.properties
        run: |
          mkdir -p android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}
          echo ${{ secrets.ANDROID_KEY_JKS }} | base64 -d > android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/release.jks
          echo 'storeFile=keystore/${{ secrets.FLAVOR_ENV_NAME }}/release.jks' >> android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/key.properties
          echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' >> android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/key.properties
          echo 'keyPassword=${{ secrets.ANDROID_ALIAS_PASSWORD }}' >> android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/key.properties
          echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' >> android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/key.properties
          cat android/app/keystore/${{ secrets.FLAVOR_ENV_NAME }}/key.properties
      # apkãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
      - name: Build APK
      # ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯flavorã§buildã—ã¦ã„ã‚‹ãŸã‚
        run: flutter build apk --release --build-number=$GITHUB_RUN_NUMBER --dart-define-from-file=lib/flavors/json/${{ secrets.FLAVOR_ENV_NAME }}.json

      # Firebase Distributionã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload apk to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          # firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ID
          appId: ${{ secrets.FIREBASE_ANDROID_ID }}
          # firebaseã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®credential json
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          # firebaseãƒ†ã‚¹ã‚¿ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—
          groups: developer
          file: ./build/app/outputs/flutter-apk/app-release.apk
          releaseNotes: ${{ github.ref_name }}
          # è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
          debug: true
```




```yaml:Version up
name: bump

on:
  workflow_dispatch:
    inputs:
      bump:
        type: choice
        description: Please Choice Bump Target
        options:
          - build
          - patch
          - minor
          - major

env:
  GIT_USER_EMAIL: '41898282+github-actions[bot]@users.noreply.github.com'
  GIT_USER_NAME: 'github-actions[bot]'

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # repositoryã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Checkout repository
        uses: actions/checkout@v4

      # flutterã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Flutter get
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: latest
          cache: true

      - name: Run flutter version
        run: flutter --version

      # Packageã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup packages
        run: |
          flutter pub get
          dart run build_runner build -d
      - name: Init git config
        run: |
          git config --local user.name $GIT_USER_NAME
          git config --local user.email $GIT_USER_EMAIL
      - name: Bump up version
        run: |
          echo choice: ${{ github.event.inputs.bump }}
          flutter pub run cider bump ${{ github.event.inputs.bump }} --bump-build
          echo "BUMP_VERSION=$(flutter pub run cider version)" >> $GITHUB_ENV
      - name: Commit and push pubspec.yaml
        run: |
          git add -u pubspec.yaml
          echo "Bumped version number to $BUMP_VERSION" | git commit --file=-
          git push
```


# å„ç¨®ç’°å¢ƒå¤‰æ•°ä¸€è¦§
| ç’°å¢ƒå¤‰æ•°å | å¯¾è±¡OS | èª¬æ˜ |
| ---- | ---- | ---- |
| ANDROID_ALIAS_PASSWORD | Android | Android ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| ANDROID_KEY_ALIAS |Android | Android keyã‚¨ã‚¤ãƒªã‚¢ã‚¹ |
| ANDROID_KEY_JKS | Android | base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿Androidã€€key jks android/app/key.jks |
| ANDROID_STORE_PASSWORD | Android | Androidã€€ã‚¹ãƒˆã‚¢ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| CREDENTIAL_FILE_CONTENT| Android/iOS | base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿firebaseã‚µãƒ¼ãƒ“ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼credential json |
| DANGER_GITHUB_API_TOKEN | Android/iOS | Dangerç”¨ã®Git Hub APIãƒˆãƒ¼ã‚¯ãƒ³ |
| EXPORT_OPTIONS | iOS | ãƒ­ãƒ¼ã‚«ãƒ«ã§archiveã—ãŸã¨ãã«ä¸€ç·’ã«ç”Ÿæˆã•ã‚Œã‚‹ExportOptions.plistã‚’base64ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—è¨­ç½® |
| FIREBASE_ANDROID_ID | Android|firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã®ã‚¢ãƒ—ãƒª ID(1:ã‹ã‚‰å§‹ã¾ã‚‹å€¤) |
| FIREBASE_AUTH_TOKEN | Android/iOS | Firebaseã®ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±|Firebaseãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—æ–¹æ³• |
| FIREBASE_IOS_ID | iOS | firebaseã€€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã®ã‚¢ãƒ—ãƒª ID(1:ã‹ã‚‰å§‹ã¾ã‚‹å€¤) |
| FIREBASE_PROJ_NAME | Android/iOS | firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå |
| FLAVOR_ENV_NAME | Android/iOS | buildã—ãŸã„ç’°å¢ƒåï¼ˆFlavorã¨ç’°å¢ƒåã‚’çµ±ä¸€ã—ã¦ã„ã‚‹ãŸã‚ï¼‰ |
| IOS_API_AUTHKEY_P8_BASE64 | iOS | AppStoreConnectAPIã§æ‰•ã„å‡ºã—ãŸAPIæƒ…å ±(base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿p8ãƒ•ã‚¡ã‚¤ãƒ«) |
| IOS_API_ISSURE_ID | iOS | AppStoreConnectAPIã§æ‰•ã„å‡ºã—ãŸAPIæƒ…å ±(IssueID) |
| IOS_API_KEY_ID | iOS | AppStoreConnectAPIã§æ‰•ã„å‡ºã—ãŸAPIæƒ…å ±(API key) |

# å‚è€ƒè¨˜äº‹
https://zenn.dev/yorifuji/articles/build-automatically-manage-singin-on-ci
https://zenn.dev/shima999ba/articles/ae1fc477744e2a
https://zenn.dev/yass97/articles/e8d1e460ae6a59
https://zenn.dev/yorifuji/articles/flutter-github-actions-template